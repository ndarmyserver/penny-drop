<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Penny Drop</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="img/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/icons/favicon-16x16.png">
    <link rel="manifest" href="img/icons/site.webmanifest">
    <link rel="mask-icon" href="img/icons/safari-pinned-tab.svg" color="#cfdcc8">
    <link rel="shortcut icon" href="img/icons/favicon.ico">
    <meta name="msapplication-TileColor" content="#cfdcc8">
    <meta name="msapplication-config" content="img/icons/browserconfig.xml">
    <meta name="theme-color" content="#cfdcc8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="Penny Drop">
    <meta property="og:image" content="https://pennydrop.johnshaida.com/img/social-sharing.jpg">
    <meta property="og:description" content="Penny Drop Dice Game">
    <meta property="og:url" content="https://pennydrop.johnshaida.com">
    <meta name="twitter:card" content="summary_large_image">

    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="title-area">
      <h1>Penny Drop</h1>
    </div>
    <div class="wrapper">
      <div class="game-area">
        <div class="drop-wrapper">
          <div class="drop-spot">
            <div class="image-container">
              <img id="penny1" src="img/penny.png" class="penny" alt="Penny" style="visibility: hidden;">
            </div>
            <hr class="drop-line">
            1
          </div>
          <div class="drop-spot">
            <div class="image-container">
              <img id="penny2" src="img/penny.png" class="penny" alt="Penny" style="visibility: hidden;">
            </div>
            <hr class="drop-line">
            2
          </div>
          <div class="drop-spot">
            <div class="image-container">
              <img id="penny3" src="img/penny.png" class="penny" alt="Penny" style="visibility: hidden;">
            </div>
            <hr class="drop-line">
            3
          </div>
          <div class="drop-spot">
            <div class="image-container">
              <img id="penny4" src="img/penny.png" class="penny" alt="Penny" style="visibility: hidden;">
            </div>
            <hr class="drop-line">
            4
          </div>
          <div class="drop-spot">
            <div class="image-container">
              <img id="penny5" src="img/penny.png" class="penny" alt="Penny" style="visibility: hidden;">
            </div>
            <hr class="drop-line">
            5
          </div>
        </div>
        <div class="spacer"></div>
        <div class="drop-wrapper">
          <div class="drop-spot"></div>
          <div class="drop-spot"></div>
          <div class="drop-spot">
            <div class="image-container">
              <img id="penny6" src="img/penny.png" class="penny" alt="Penny" style="visibility: hidden;">
            </div>
            <hr id="dropLine6" class="drop-line">
            6
          </div>
          <div class="drop-spot"></div>
          <div class="drop-spot"></div>
        </div>
        <div class="spacer-large"></div>
        <div id="dice" class="dice"><img src="img/dice-0.png" id="dice-img" class="dice" alt="Blank Dice"></div>
        <div class="spacer-large"></div>
        <div class="button-wrapper">
          <div id="passButton" class="pass-button" style="visibility: hidden;">PASS</div>
          <div id="rollButton" class="roll-button">ROLL</div>
        </div>
        <div class="spacer-large"></div>
        <div id="stackWrapper" class="stack-wrapper">
          <div id="player0-stack-spot" class="stack-spot">
            <div id="player0-name" class="player-name"></div>
            <div id="player0-stack" class="player-stack"></div>
          </div>
          <div id="player1-stack-spot" class="stack-spot">
            <div id="player1-name" class="player-name"></div>
            <div id="player1-stack" class="player-stack"></div>
          </div>
          <div id="player2-stack-spot" class="stack-spot" style="display: none;">
            <div id="player2-name" class="player-name"></div>
            <div id="player2-stack" class="player-stack"></div>
          </div>
          <div id="player3-stack-spot" class="stack-spot" style="display: none;">
            <div id="player3-name" class="player-name"></div>
            <div id="player3-stack" class="player-stack"></div>
          </div>
          <div id="player4-stack-spot" class="stack-spot" style="display: none;">
            <div id="player4-name" class="player-name"></div>
            <div id="player4-stack" class="player-stack"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="settings">
      <ion-icon name="settings-outline" onClick="onSettingsClick()"></ion-icon>
    </div>
    <div class="modal" id="modal-setup">
      <div class="modal-bg modal-exit"></div>
      <div class="modal-container">
        <div id="setupPrompt">
          <h2>How many players?</h2>
          <div class="spacer"></div>
          <div class="number-players-container">
            <div id="minus-button" class="left-col">
              <ion-icon name="remove-circle-outline" onClick="onPlayerMinusClick()"></ion-icon>
            </div>
            <div class="center-col">
              <span id="num-of-kid-tickets">2</span>
            </div>
            <div id="plus-button" class="right-col">
              <ion-icon name="add-circle-outline" onClick="onPlayerPlusClick()"></ion-icon>
            </div>
          </div>
        </div>
        <div class="player-names-form-container">
          <h3 id="playerNames" style="display: none;">Enter Player Names</h3>
          <div class="spacer"></div>
          <input id="player0" name="player1" type="text" placeholder="Player 1" style="display: none;">
          <input id="player1" name="player2" type="text" placeholder="Player 2" style="display: none;">
          <input id="player2" name="player3" type="text" placeholder="Player 3" style="display: none;">
          <input id="player3" name="player4" type="text" placeholder="Player 4" style="display: none;">
          <input id="player4" name="player5" type="text" placeholder="Player 5" style="display: none;">
        </div>
        <div id="setupError" class="setup-error" style="visibility: hidden;">
          <p>Player's name can not be blank.</p>
        </div>
        <div class="spacer-setup-error"></div>
        <div id="firstNextButton" class="first-next-button">NEXT <ion-icon name="arrow-forward-outline" class="ion-arrows"></ion-icon></div>
        <div id="setupButtonWrapper" class="setup-button-wrapper" style="display: none;">
          <div id="backButton" class="back-button">
            <ion-icon name="arrow-back-outline" class="ion-arrows"></ion-icon> BACK</div> <div id="nextButton" class="next-button">NEXT <ion-icon name="arrow-forward-outline" class="ion-arrows"></ion-icon>
          </div>
          <div id="playButton" class="play-button" style="display: none;">PLAY <ion-icon name="arrow-forward-outline" class="ion-arrows"></ion-icon></div>
        </div>
        <!-- <button id="modal-one-exit" class="modal-close modal-exit">X</button> -->
      </div>
    </div>
    <div class="modal" id="modal-settings">
      <div class="modal-settings-bg modal-exit"></div>
      <div class="modal-container">
        <div id="settingsResumeButton" class="resume-button"><ion-icon name="arrow-back-outline" class="ion-rematch"></ion-icon> RESUME</div>
        <div class="spacer-large"></div>
        <div id="settingsRematchButton" class="rematch-button">RESTART <ion-icon name="refresh-outline" class="ion-rematch"></ion-icon></div>
        <div class="spacer-large"></div>
        <div id="settingsNewGameButton" class="new-game-button">NEW GAME</div>
        <!-- <button id="modal-one-exit" class="modal-close modal-exit">X</button> -->
      </div>
    </div>
    <div class="modal" id="modal-win">
      <div class="modal-winner-bg modal-exit"></div>
      <div class="modal-container">
        <ion-icon name="close-circle-outline" class="ion-win-close" onClick="onWinCloseClick()"></ion-icon>
        <h1 id="winner" class="winner"></h1>
        <h2>is the winner!</h2>
        <div class="spacer-large"></div>
        <div class="win-stats">
          <h2>Game Stats</h2>
          <div class="spacer-small"></div>
          <p id="winRounds"></p>
          <div class="spacer-small"></div>
          <p>Roll Distributions</p>
          <div class="spacer-extra-small"></div>
          <div class="win-distribution-container">
            <table>
              <thead>
                <tr>
                  <th>1</th>
                  <th>2</th>
                  <th>3</th>
                  <th>4</th>
                  <th>5</th>
                  <th>6</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="win1"></td>
                  <td id="win2"></td>
                  <td id="win3"></td>
                  <td id="win4"></td>
                  <td id="win5"></td>
                  <td id="win6"></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="spacer-small"></div>
        </div>
        <div class="spacer-large"></div>
        <div id="rematchButton" class="rematch-button">REMATCH <ion-icon name="refresh-outline" class="ion-rematch"></ion-icon></div>
        <div class="spacer-large"></div>
        <div id="newGameButton" class="new-game-button">NEW GAME</div>
        <!-- <button id="modal-one-exit" class="modal-close modal-exit">X</button> -->
      </div>
    </div>
  </body>

  <script type="text/javascript">

    var players = [];
    var playerStacks = [];
    var gameEnded = false;
    var currentPlayer = 0;
    var firstTurn = true;
    var spots = [false, false, false, false, false];
    var allRolls = [];
    var rounds = 1;
    var setupProgression = 0;

    const modalSetup = document.getElementById('modal-setup');
    const modalWin = document.getElementById('modal-win');
    const modalSettings = document.getElementById('modal-settings');

    // Open Game Setup modal on page load
    modalSetup.classList.add("open");

    function onSettingsClick() {
      modalSettings.classList.add("open");
    }

    function displayWinner(winner) {
      document.getElementById('rollButton').style.visibility = "hidden";
      document.getElementById('passButton').style.visibility = "hidden";
      document.getElementById("winner").innerText = winner;
      console.log("all rolls: " + allRolls);
      document.getElementById("winRounds").innerText = `Rounds: ${rounds}`
      for (x = 1; x < 7; x++) {
        console.log(allRolls.length);
        console.log(allRolls.filter((v) => (v === x)).length);
        console.log((allRolls.filter((v) => (v === x)).length) / allRolls.length);
        document.getElementById("win" + x).innerText = `${Math.round((allRolls.filter((v) => (v === x)).length / allRolls.length) * 100)}%`
      }
      modalWin.classList.add("open");
    }
    // const exit = document.getElementById("modal-one-exit");
    // exit.addEventListener("click", function (event) {
    // event.preventDefault();
    // modal.classList.remove("open");
    // });



    var kid_tickets = 2;

    function onPlayerMinusClick() {
      if (kid_tickets > 2) {
        kid_tickets -= 1;
        if (kid_tickets == 2) {
          document.getElementById("minus-button").style.visibility = "hidden";
        }
        if (kid_tickets == 4) {
          document.getElementById("plus-button").style.visibility = "visible";
        }
      } else {
        kid_tickets = 2;
      }
      document.getElementById("num-of-kid-tickets").innerText = kid_tickets;
    };

    function onPlayerPlusClick() {
      if (kid_tickets < 5) {
        kid_tickets += 1;
        if (kid_tickets == 5) {
          document.getElementById("plus-button").style.visibility = "hidden";
        }
        document.getElementById("num-of-kid-tickets").innerText = kid_tickets;
        if (kid_tickets > 2) {
          document.getElementById("minus-button").style.visibility = "visible";
        }
      }
    };

    document.getElementById('firstNextButton').addEventListener('click', function() {
      setupProgression = 1;
      document.getElementById('setupPrompt').style.display = "none";
      document.getElementById('firstNextButton').style.display = "none";
      document.getElementById('setupButtonWrapper').style.display = "grid";
      document.getElementById('playerNames').style.display = "block";
      document.getElementById('player0').style.display = "block";
      document.getElementById('player0').focus();
      console.log("kid tickets: " + kid_tickets)
      console.log(setupProgression)
    });

    document.getElementById('backButton').addEventListener('click', function() {
      if (setupProgression == 1) {
        document.getElementById('playerNames').style.display = "none";
        document.getElementById('player0').style.display = "none";
        document.getElementById('setupButtonWrapper').style.display = "none";
        document.getElementById('setupError').style.visibility = "hidden";
        document.getElementById('setupPrompt').style.display = "block";
        document.getElementById('firstNextButton').style.display = "block";
      } else {
        document.getElementById('setupError').style.visibility = "hidden";
        document.getElementById('player' + (setupProgression - 1)).style.display = "none";
        document.getElementById('player' + (setupProgression - 2)).style.display = "block";
        document.getElementById('player' + (setupProgression - 2)).focus();
        if (setupProgression == kid_tickets) {
          document.getElementById('playButton').style.display = "none";
          document.getElementById('nextButton').style.display = "block";
        }
      }
      setupProgression -= 1;
      console.log(setupProgression)
    });

    document.getElementById('nextButton').addEventListener('click', function() {
      if (document.getElementById('player' + (setupProgression - 1)).value == "") {
        document.getElementById('setupError').style.visibility = "visible";
        document.getElementById('player' + (setupProgression - 1)).focus();
        return false;
      } else {
        document.getElementById('setupError').style.visibility = "hidden";
        document.getElementById('player' + (setupProgression - 1)).style.display = "none";
        setupProgression += 1;
        document.getElementById('player' + (setupProgression - 1)).style.display = "block";
        document.getElementById('player' + (setupProgression - 1)).focus();
        if (setupProgression == kid_tickets) {
          document.getElementById('nextButton').style.display = "none";
          document.getElementById('playButton').style.display = "block";
        }
        console.log(setupProgression)

      }
    });


    document.getElementById('playButton').addEventListener('click', function() {
      if (document.getElementById('player' + (setupProgression - 1)).value == "") {
        document.getElementById('setupError').style.visibility = "visible";
        document.getElementById('player' + (setupProgression - 1)).focus();
        return false;
      } else {
        for (var l = 0; l < 5; l++) {
          players.push(document.getElementById('player' + l).value)
        }
        console.log(players);

        players = players.filter(element => {
          return element !== '';
        });
        console.log(players);

        players.forEach(element => {
          playerStacks.push(10);
        });
        console.log(playerStacks);
        var numColumns = ""
        switch (kid_tickets) {
          case 2:
             numColumns = "1fr 1fr";
            break;
          case 3:
            numColumns = "1fr 1fr 1fr";
            break;
          case 4:
            numColumns = "1fr 1fr 1fr 1fr";
            break;
          case 5:
            numColumns = "1fr 1fr 1fr 1fr 1fr";
            break;
          default:
            console.log("something went wrong.");
        }
        document.getElementById('stackWrapper').style.gridTemplateColumns = numColumns;
        // Checks if media query for less than 601px wide is true

        if (window.matchMedia('(max-width: 600px)').matches) {
          var stackElements = document.getElementsByClassName('player-stack');
          var nameElements = document.getElementsByClassName('player-name');
          switch (kid_tickets) {
            case 3:
              Array.from(nameElements).forEach(element => element.classList.add("small-name-font"));
              break;
            case 4:
              Array.from(nameElements).forEach(element => element.classList.add("tiny-name-font"));
              break;
            case 5:
              Array.from(stackElements).forEach(element => element.classList.add("small-stack-font"));
              Array.from(nameElements).forEach(element => element.classList.add("micro-name-font"));
              break;
            default:
              console.log("didn't need to adjust font");
          }
        }
        modalSetup.classList.remove("open");
        playGame();
      }
    });
    // For testing before implementing number of player modal
    // var players = ["Johnny", "Mommy", "Kate", "Brooke", "Daddy"];
    //   var players = ["Johnny", "Daddy"];
    // var playerStacks = [10, 10, 10, 10, 10];
    //   var playerStacks = [10, 10];
    function rollDiceAnimation() {
      // document.getElementById('dice').innerHTML = (Math.floor(Math.random() * 6) + 1);
      var randomNumber = (Math.floor(Math.random() * 6) + 1);
      document.getElementById('dice-img').src = "img/dice-" + randomNumber + ".png";
      document.getElementById('dice-img').alt = "Dice - " + randomNumber;
      return new Promise((resolve) => {
        setTimeout(function() {
          resolve();
        }, 20);
      });
    }

    function afterRolling() {

      var rollDice = (Math.floor(Math.random() * 6) + 1);
      allRolls.push(rollDice);
      document.getElementById('dice-img').src = "img/dice-" + rollDice + ".png";
      document.getElementById('dice-img').alt = "Dice - " + rollDice;

      if (rollDice >= 1 && rollDice <= 5) {
        if (spots[rollDice - 1]) {
          const numOfPennies = spots.filter(Boolean).length;
          playerStacks[currentPlayer] += numOfPennies;
          document.getElementById('player' + currentPlayer + '-stack').innerHTML = playerStacks[currentPlayer];
          for (let j = 0; j < 5; j++) {
            if (spots[j]) {
              document.getElementById("penny" + (j + 1)).classList.add('slide-up');
            }
          }
          setTimeout(function() {
            for (let j = 0; j < 5; j++) {
              document.getElementById("penny" + (j + 1)).style.visibility = "hidden"
              if (spots[j]) {
                document.getElementById("penny" + (j + 1)).classList.remove('slide-up');
              }
              spots[j] = false;
            }
          }, 1000);


          // Turn is over and advance to next player
          document.getElementById('player' + currentPlayer + '-name').classList.toggle("active-player");
          console.log(currentPlayer + " of " + (players.length - 1));
          if (currentPlayer == (players.length - 1)) {
            currentPlayer = 0;
            rounds++;
          } else {
            currentPlayer++;
          }
          document.getElementById('player' + currentPlayer + '-name').classList.toggle("active-player");
          document.getElementById('passButton').style.visibility = "hidden";
          firstTurn = true;


        } else {
          var x = document.getElementById("penny" + rollDice);
          if (x.style.visibility === "hidden") {
            x.style.visibility = "visible";
          } else {
            x.style.visibility = "hidden";
          }

          spots[rollDice - 1] = true;

          playerStacks[currentPlayer]--;
          document.getElementById('player' + currentPlayer + '-stack').innerHTML = playerStacks[currentPlayer];
          if (playerStacks[currentPlayer] == 0) {
            setTimeout(function() {
              displayWinner(players[currentPlayer]);
            }, 1000);
          }
          if (firstTurn) {
            firstTurn == false;
            document.getElementById('passButton').style.visibility = "visible";
          }
        }
      } else { // 6 was rolled
        document.getElementById("penny" + rollDice).style.visibility = "visible";
        setTimeout(function() {
          document.getElementById("penny" + rollDice).classList.add('slide-out');
        }, 500);
        setTimeout(function() {
          document.getElementById("penny" + rollDice).style.visibility = "hidden";
          document.getElementById("penny" + rollDice).classList.remove('slide-out');
        }, 1000);

        playerStacks[currentPlayer]--;
        document.getElementById('player' + currentPlayer + '-stack').innerHTML = playerStacks[currentPlayer];
        if (playerStacks[currentPlayer] == 0) {
          setTimeout(function() {
            displayWinner(players[currentPlayer]);
          }, 1000);

        }
        if (firstTurn) {
          firstTurn == false;
          document.getElementById('passButton').style.visibility = "visible";
        }
      }
    }

    async function rollButtonPressed() {
      document.getElementById('rollButton').style.pointerEvents = 'none';
      document.getElementById('passButton').style.pointerEvents = 'none';
      document.getElementById('rollButton').style.background = '#808080';
      document.getElementById('passButton').style.background = '#808080';

      console.log("wait to roll again")
      for (var k = 0; k < 25; k++) {
        await rollDiceAnimation();
      }
      afterRolling();
      setTimeout(function() {
        document.getElementById('rollButton').style.pointerEvents = 'auto';
        document.getElementById('passButton').style.pointerEvents = 'auto';
        document.getElementById('rollButton').style.background = '#D98D62';
        document.getElementById('passButton').style.background = '#90a68a';
        console.log("ready to roll again")
      }, 500);


    }


    document.getElementById('rollButton').addEventListener('click', function() {
      console.log("roll button pressed");
      rollButtonPressed();
    });

    document.getElementById('passButton').addEventListener('click', function() {
      document.getElementById('player' + currentPlayer + '-name').classList.toggle("active-player");
      if (currentPlayer == (players.length - 1)) {
        currentPlayer = 0;
        rounds++
      } else {
        currentPlayer++;
      }
      document.getElementById('player' + currentPlayer + '-name').classList.toggle("active-player");
      firstTurn = true
      document.getElementById('passButton').style.visibility = "hidden";
    });

    function playGame() {
      for (const [i, name] of players.entries()) {
        console.log(name);
        document.getElementById('player' + i + '-stack-spot').style.display = "block";
        document.getElementById('player' + i + '-name').innerHTML = name;
        document.getElementById('player' + i + '-stack').innerHTML = playerStacks[i];

      }

      document.getElementById('player' + currentPlayer + '-name').classList.toggle("active-player");
      document.getElementById('passButton').style.visibility = "hidden";

    }

    function restartCurrentGame() {
      document.getElementById('player' + currentPlayer + '-name').classList.toggle("active-player");
      playerStacks = [];
      gameEnded = false;
      currentPlayer = 0;
      firstTurn = true;
      spots = [];
      spots = [false, false, false, false, false];
      allRolls = [];
      rounds = 1;
      document.getElementById('dice-img').src = "img/dice-0.png";
      document.getElementById('rollButton').style.visibility = "visible";
      var imgElements = document.getElementsByClassName('penny');
      Array.from(imgElements).forEach(element => element.style.visibility = "hidden");
      players.forEach(element => {
        playerStacks.push(10);
      });
      console.log(playerStacks);
      playGame();
    }

    document.getElementById('settingsResumeButton').addEventListener('click', function() {
      modalSettings.classList.remove("open");
    });

    document.getElementById('settingsRematchButton').addEventListener('click', function() {
      restartCurrentGame();
      modalSettings.classList.remove("open");
    });

    document.getElementById('settingsNewGameButton').addEventListener('click', function() {
      location.reload();
    });

    document.getElementById('rematchButton').addEventListener('click', function() {
      restartCurrentGame();
      modalWin.classList.remove("open");
    });

    function onWinCloseClick() {
      modalWin.classList.remove("open");
    }

    document.getElementById('newGameButton').addEventListener('click', function() {
      location.reload();
    });

  </script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

</html>